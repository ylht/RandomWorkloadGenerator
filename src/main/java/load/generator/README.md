# 负载生成器

目录

[TOC]



# 引言

在数据库的研究中，经常会用各种benchmark来做性能的评测，比如常见的tpcc，smallbank等等，但是他们主要是为单一应用场景设计的负载模式，无法满足多样化的性能评测和数据库研究的需求。因此我们需要一款随机的负载生成器来模拟更加复杂的负载模式。它生成的负载理论上应该能覆盖当前所有常见的benchmark负载，并且可以生成更多的具有实际应用意义的负载。

# 设计思路

统计常用benchmark的数据，获取常见负载各种数据的频率分布，在对应区间内随机模拟生成负载。

# 数据统计

本项目主要统计了常见的四个benchmark的负载数据，分别为TPCC，Tatp，SmallBank和Seats。其中前3个benchmark 的统计来自官方文档的表述，Seats的统计来自于oltp的实现。统计数据的具体结果放在本项目的根目录下，可自行查阅。统计数据包括table数据和事务的sql数据。下面将选取一些数据做具体表述：

## table数据

初始统计数据分别为：表的主键数量，外键的数量，各个的属性的数量，其中统计的属性包括int，decimal，timestamp，char，varchar，float 。数据统计之后分析了table的tuple总数量概率分布，和具体的属性数量的概率分布。分析结果如下：

![image-20180904213539372](https://ws1.sinaimg.cn/large/006tNbRwly1fuxu5ciwuxj30p80smdjl.jpg)

除了属性的数量信息，还统计了属性的一些内容信息，比如varchar和char的区间长度，decimal整数位和小数位的区别，最后统计了下对于所有的table来说每个属性的范围值

![image-20180904213700763](https://ws3.sinaimg.cn/large/006tNbRwly1fuxu51rc58j30pm0v8jvm.jpg)

**关于键和结构的分析**

从统计结果来看，对于任意一个存在真实意义的表都满足以下的键值组成。

1. 主键有多列属性

   一般只有一列是单独列，即不参考其他表的列，如下图中的KeyRate，其他用于组成主键的列，如FK1和FK2都是外键。

2. 主键只有一列属性

   如果主键只有一列，那么一般不会参考外键。

3. 外键数量

   一般来说主键的部分列会使用外键参考其他的表，并且除主键外，其他的属性列也会有可能产生外键引用

![image-20180910210502115](https://ws2.sinaimg.cn/large/006tNbRwly1fv4qxmvr1wj31500ikta4.jpg)

## sql数据

1. 按照事务分别统计了事务的组成分布，主要包括select，update，delete和insert在每个事务中的数量。分析统计了每种语句在事务中的概率分布。
2. 对于select语句统计了各个属性的selcet数量，condition的类别，orderby的选择，limit的应用和是否存在sum，count等操作
3. 对于update语句统计了各个属性的update数量，和rw和w的比例（rw：a=a+b型语句；w：a=b型语句）
4. 对于insert语句统计了插入非主键属性的数量
5. 对于delete语句统计了condition 的条件

# 系统架构

系统的架构图如下：

![负载生成器架构图](https://ws4.sinaimg.cn/large/006tNbRwly1fv4qs7790kj30pi0c4dhd.jpg)

包含3个模块，分别是数据模块，功能模块和连接模块，箭头描述的是数据传递的路径，接下来将分3个章节来具体表述这3个模块。

## 数据模块

基础的数据结构模块，包含表格的结构，随机数据生成器和键值数据生成器。

### 表格结构

表格table由tuple子结构，外键引用和表格基础属性组成。

1. tuple子结构

   Table的基础结构是tuple，tuple按照基本的类型来区别，tuple的类型包括int, decimal, float, char, varchar, date。每个tuple维护自己的数据区间和数据格式。

   + 数据区间为数据的合法区间。例如，在int/decimal等数值型tuple中，数据区间为数据的最小值和最大值；在char类型中，数据区间代表数据的长度或者数据的基础库，比如姓氏库或者省份名称库等等
   + 数据格式为数据的格式要求，例如在decimal中的总位数和小数点后的位数。

2. 表格的基础属性

   包括表格的主键数量，表大小等基础数据

3. 外键引用

   由TupleForeign维护，记录本表引用的表，引用的列，本表中引用这些列的列。

### 随机数据生成器的结构

数据生成器从对应的tuple中获取数据区间，在数据区间中按照一定的规则生成随机数据。数据生成的类型有四种，分别为int，demical，date和char。

+ int维持两种数据生成器，一种是随机生成器用于生成随机的int数据，一种是自增列，用于生成主键的自增序列
+ demical维持在数值范围区间内的随机生成器
+ char维持3中随机生成器
  + 从对应的主键列的数据int转化为char，超过长度则截断，不足长度在头部补0
  + 在数据长度的范围内随机所有字母
  + 首先生成字符库，之后在字符库中随机
+ date维持时间的生成器，返回当前的时间。

### 键值数据生成器的结构

键值生成器主要用于生成合法的主键，主要是给出两种主键。

1. 无序键值，比如select或者update的主键，给出在主键数据的合法区间内的一个随机键值，
2. 有序键值，比如insert或者delete的主键，按照固定的顺序给出一个键值。在delete的时候键值是从头部依次向下给出，即delete数据从上向下删除，insert的数据从尾部向下给出

## 功能模块

功能模块主要包括4个，表格的scheme生成，表格的数据生成，负载生成，多线程执行下面简述主要功能逻辑：

### scheme生成

1. 按照统计的数据随机生成table 的数量
2. 按照统计的数据随机生成每种类型的tuple的数量，并按照统计数据随机实例化不同的tuple
3. 生成主键属性数量（如果是第N张表，主键必定小于等于N个属性，否则没有参考值），主键的第一列为KeyRate，代表本表的表的缩放比例，如果只有一个属性，那么KeyRate的范围就是表的数量大小。
4. 按照统计的数据随机生成外键的数量，

### 数据生成

1. 按照表的顺序生成随机数据，防止出现外键依赖
2. 对于每一张表，按照相应的tuple获取其数据区间，生成对应的随机数生成器
3. 根据table中设定的表大小，循环生成每一行数据，将其写入文件
4. 依次生成所有的数据

### 负载生成

负载生成主要包括负载模板生成，随机生成器组合，顺序打乱。

1. 负载模版生成

**Select模板**

随机生成select中的int属性，char属性等各个属性的数目，从表中筛选出相应数目的属性名称；

条件选择：

+ 主键选择，选择这张表的全部主键属性作为条件
+ 缺失一个主键，可能存在order by和limit
+ 缺失一个主键，在一个其他属性上取值或者range，例如选择姓氏
+ 缺失两个主键（在其他的一个属性上取range或者定值）
+ 两表join，包含上述的约束条件

**Update模板**

随机生成update中的int属性，char属性等各个属性的数目，从表中筛选出相应数目的属性名称；

按照随机比例分配，rw和w的数目，rw例为a=a+1，w例为a=1；

条件选择：主键选择，选择这张表的全部主键属性作为条件

**Delete模板**

条件选择：主键选择，选择这张表的全部主键属性作为条件

**Insert模板**

随机生成update中的int属性，char属性等各个属性的数目，从表中筛选出相应数目的属性名称；

条件选择：主键选择，选择这张表的全部主键属性作为条件

2. 随机生成器组合

   按照负载模板中对应的列，从对应的tuple中获取range，生成随机生成器序列

3. 顺序打乱

   顺序打乱主要有两种方法。

   - 生成所有的事务一共所需的各种语句的模板，无放回的每次抽一个语句，组成各个事务
   - 为每个事务随机生成数量确定的各种语句，之后打乱顺序

### 多线程执行

将事务集的实例分配给多个线程，每个线程维持一个数据库连接，每次随机一个事务，事务内部调用随机生成器，补全事务模板，输出sql语句交给线程连接提交。完成随机负载。

## 连接模块

用于维持合数据库的连接，通过适配不同的驱动可以连接多种数据库

# 部分点具体设计介绍

##表大小与主键属性范围

主键如果只有一个属性，则属性范围更新为表大小的范围，设置此表为不可insert，delete。

如果主键有多个属性，则必然存在一个不参考外键数量值，则用表大小值，从右到左依次除以当前属性的范围，来获取此值的区间，然后将此区间设置为所求值的2倍，方便用来insert

## 外键引用

1. 现有的主键数目减1为主键中需要引用的外键数目，然后按照统计记录生成非主键的tuple需要外键的数目
2. 随机一张在此表之前出现的表，引用此表中的所有主键属性，若数目不够此表所需的外键数，则继续随机，直到随需的外键数目达到，或者没有表可以引用，每次引用需要新建一个tupleForeign实例。
3. 由于可能会出现以下情况，如：B中的2属性引用A中的1属性，而此时新建的表C需要外键，首先C（2）从B中引用到2，然后数目不够则C（3）引用表A中的1属性，则C引用了C(2)->B(2)->A(1)和C（3）->A(1)，但是这在应用中是不存在的，所以C引用B之后，便会在随机区间中去处B引用的表，防止重复引用。
4. 从引用的表中继承相应tuple的数据范围
5. 如果外键的引用数不足主键数减1，则减少主键属性的数目 *

## 数据导入

1. 按照表的顺序生成数据，防止出现外键约束
2. 每一个表数据的生成，由随机生成器集生成每一行的数据，将其写入到对应表的文件中
3. 将数据导出到文件中，之后将数据传输到数据库

##负载数据生成

1. 每一个sql绑定一个randomValue List，用作生成这个sql所需要的数据

##条件选择

可重复主键选择，例如select和upadte，可以交给随机生成器完全随机，其中可以采用tuple选择的range比例来控制冲突；

不可重复主键选择，insert和delete，需要给每个线程按照线程id，分配能操作的区间，每个线程内，按照线性顺序insert和delete，保证稳定。

其他键选择，由于都在select上可以采用全随机方式。